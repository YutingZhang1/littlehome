<view class="container">
  <!-- 删除自定义导航栏，直接显示页面内容 -->

  <!-- 情侣绑定展示和入口 -->
  <view class="couple-bind-container" bindtap="showCoupleBindModal">
    <view wx:if="{{isBinded}}">
      <image class="couple-avatar" src="{{partner.avatar}}" mode="aspectFill"/>
      <text class="couple-nickname">已绑定：{{partner.nickname}}</text>
    </view>
    <view wx:else>
      <text class="couple-unbind">未绑定情侣，点击绑定</text>
    </view>
  </view>

  <!-- 情侣绑定弹窗 -->
  <view wx:if="{{showCoupleBindModal}}" class="couple-bind-modal">
    <view class="modal-mask" bindtap="hideCoupleBindModal"></view>
    <view class="modal-content">
      <view class="modal-title">情侣绑定</view>
      <view wx:if="{{isBinded}}" class="modal-bind-status">
        <view class="couple-pair">
          <image class="couple-avatar left" src="{{partner.avatar}}" mode="aspectFill"/>
          <view class="chain-connector"></view>
          <image class="couple-avatar right" src="{{userInfo.avatarUrl}}" mode="aspectFill"/>
        </view>
        <view class="couple-names">
          <text class="couple-name left">{{partner.nickname}}</text>
          <text class="couple-name right">{{userInfo.nickName}}</text>
        </view>
        <text>已绑定情侣关系</text>
        <button class="unbind-btn" bindtap="showUnbindConfirm">解绑</button>
      </view>
      <view wx:else>
        <view wx:if="{{bindCode}}" class="bind-code-section">
          <text class="bind-code-label">你的绑定码：</text>
          <view class="bind-code-container" bindtap="copyBindCode">
            <text class="bind-code-text">{{bindCode}}</text>
            <text class="copy-icon">📋</text>
          </view>
        </view>
        <view class="bind-input-section">
          <text class="bind-input-label">输入对方绑定码：</text>
          <input class="bind-input" placeholder="请输入对方的绑定码" value="{{inputBindCode}}" bindinput="onInputBindCode"/>
        </view>
        <button class="pretty-gradient-btn" bindtap="bindWithCode">绑定</button>
      </view>
      <button class="pretty-gradient-btn" bindtap="hideCoupleBindModal">关闭</button>
    </view>
  </view>

  <!-- 解绑确认弹窗 -->
  <view wx:if="{{showUnbindConfirm}}" class="unbind-confirm-modal">
    <view class="modal-mask" bindtap="hideUnbindConfirm"></view>
    <view class="modal-content">
      <view class="modal-title">⚠️ 解绑确认</view>
      <view class="unbind-warning">
        <text class="warning-text">确定要解除与 {{partner.nickname}} 的情侣绑定吗？</text>
        <text class="warning-desc">解绑后将无法查看对方的动态和状态</text>
      </view>
      <view class="unbind-buttons">
        <button class="cancel-btn" style="width: 200rpx;" bindtap="hideUnbindConfirm">取消</button>
        <button class="confirm-unbind-btn" style="width: 200rpx;"  bindtap="confirmUnbind">确认解绑</button>
      </view>
    </view>
  </view>

  <!-- 计时器 -->
  <view class="timer-container" bindtap="showAnniversaryPicker">
    <text class="timer-text">{{currentAnniversary.title}}</text>
    <text class="timer-days">{{days}}天</text>
    <text class="timer-detail">{{hours}}时{{minutes}}分{{seconds}}秒</text>
    <text class="timer-date">{{currentAnniversary.date}}</text>
  </view>

  <!-- 纪念日选择弹窗 -->
  <view wx:if="{{showAnniversaryPicker}}" class="anniversary-picker-modal">
    <view class="modal-mask" bindtap="hideAnniversaryPicker"></view>
    <view class="modal-content">
      <view class="modal-title">选择纪念日</view>
      <view class="anniversary-list">
        <view class="anniversary-item" wx:for="{{anniversaries}}" wx:key="id" bindtap="selectAnniversary" data-id="{{item.id}}">
          <text>{{item.title}}：{{item.date}}</text>
        </view>
      </view>
      <button class="pretty-gradient-btn" bindtap="hideAnniversaryPicker">关闭</button>
    </view>
  </view>

  <!-- 背景容器 -->
  <view class="garden-container">
    <image class="background" src="https://littlehome-1301530190.cos.ap-nanjing.myqcloud.com/pic/bg2.jpg" mode="aspectFill"/>
  </view>

  <!-- 小家家具和效果 -->
  <view class="home-image-wrapper">
    <!-- 空调 -->
    <view class="furniture aircondition" bindtap="onAirConditionTap">
      <image src="https://littlehome-1301530190.cos.ap-nanjing.myqcloud.com/pic/aircondition.png" mode="aspectFit"/>
    </view>
    <canvas canvas-id="airEffectCanvas" class="effect-canvas air-effect-canvas" wx:if="{{showAirEffect}}"></canvas>
    
    <!-- 冰箱 -->
    <view class="furniture fridge" bindtap="onFridgeTap">
      <image src="https://littlehome-1301530190.cos.ap-nanjing.myqcloud.com/pic/bingxiang.png" mode="aspectFit"/>
    </view>
    <canvas canvas-id="fridgeEffectCanvas" class="effect-canvas fridge-effect-canvas" wx:if="{{showFridgeEffect}}"></canvas>
    
    <!-- 风扇 -->
    <view class="furniture fan" bindtap="onFanTap">
      <image src="https://littlehome-1301530190.cos.ap-nanjing.myqcloud.com/pic/fengshan.png" mode="aspectFit"/>
    </view>
    <canvas canvas-id="fanEffectCanvas" class="effect-canvas fan-effect-canvas" wx:if="{{showFanEffect}}"></canvas>
    
    <!-- 沙发 -->
    <view class="furniture sofa" bindtap="onSofaTap">
      <image src="https://littlehome-1301530190.cos.ap-nanjing.myqcloud.com/pic/sofa1.png" mode="aspectFit"/>
    </view>
    <canvas canvas-id="sofaEffectCanvas" class="effect-canvas sofa-effect-canvas" wx:if="{{showSofaEffect}}"></canvas>
  </view>

  <!-- 角色元素 -->
  <image class="character" src="{{characterImage}}" bindtap="onCharacterTap" data-action="{{currentAction}}" style="opacity: {{characterOpacity}};"/>
  
  <!-- 动作选择框 -->
  <view class="action-selector">
    <view class="action-selector-header">
      <text class="action-selector-title">🎭 动作</text>
    </view>
    <scroll-view class="action-list" scroll-x="true" enhanced="true" show-scrollbar="false">
      <view class="action-item {{currentAction === action ? 'active' : ''}}" 
            wx:for="{{actions}}" 
            wx:key="*this" 
            wx:for-item="action"
            bindtap="selectAction"
            data-action="{{action}}">
        <view class="action-icon">{{actionIcons[action]}}</view>
        <text class="action-name">{{actionNames[action]}}</text>
      </view>
    </scroll-view>
  </view>

  <!-- 聊天功能 -->
  <view class="chat-container" wx:if="{{showChat}}">
    <view class="chat-content">


      
      <!-- 聊天气泡 -->
      <view class="chat-bubbles" id="chat-bubbles" data-force-update="{{forceUpdate}}">
        <!-- 消息列表 -->
        <view wx:for="{{chatMessages}}" wx:key="timestamp" class="chat-message {{item.type === 'user' ? 'user-message' : 'character-message'}}">
          <view class="message-header">
            <text class="message-avatar">{{item.type === 'user' ? '👤' : '🐭'}}</text>
            <text class="message-name">{{item.type === 'user' ? '我' : '鼠鼠'}}</text>
            <text class="message-time">{{item.timeText || '刚刚'}}</text>
          </view>
          <view class="message-content">{{item.content}}</view>
        </view>
        
        <!-- 空消息提示 -->
        <view wx:if="{{chatMessages.length === 0}}" class="empty-message">
          <text class="empty-text">还没有消息，开始聊天吧~</text>
        </view>
        
        <!-- 加载动画 -->
        <view class="loading-message" wx:if="{{isChatLoading}}">
          <view class="loading-content">
            <view class="loading-dots">
              <view class="dot"></view>
              <view class="dot"></view>
              <view class="dot"></view>
            </view>
            <text class="loading-text">鼠鼠正在思考...</text>
          </view>
        </view>
      </view>
      
      <!-- 输入框 -->
      <view class="chat-input-container">
        <input class="chat-input" 
               placeholder="和角色聊天..." 
               value="{{chatInputText}}"
               bindinput="onChatInput"
               bindconfirm="sendChatMessage"
               confirm-type="send"/>
        <button class="send-btn" bindtap="sendChatMessage">发送</button>
      </view>
      
      <!-- 关闭聊天按钮 -->
      <button class="close-chat-btn" style="width: 50rpx;height: 90rpx;" bindtap="closeChat">✕</button>
    </view>
  </view>

  <!-- 聊天按钮 -->
  <view class="chat-trigger" bindtap="openChat" wx:if="{{!showChat}}">
    <text class="chat-trigger-text">💬</text>
  </view>
  
  <!-- 情感报告按钮 -->
  <view class="emotion-report-trigger {{reportButtonShaking ? 'shaking' : ''}}" 
        bindtap="showEmotionReport" 
        wx:if="{{hasReportGenerated}}">
    <text class="emotion-report-trigger-text">📊</text>
    <text class="emotion-report-trigger-label">情感报告</text>
  </view>
  
  <!-- 调试信息 -->
  <view style="position: fixed; top: 100rpx; right: 20rpx; background: rgba(0,0,0,0.7); color: white; padding: 10rpx; border-radius: 8rpx; font-size: 20rpx;">
    <text>hasReportGenerated: {{hasReportGenerated}}</text><br/>
    <text>showEmotionReport: {{showEmotionReport}}</text><br/>
    <text>isGeneratingReport: {{isGeneratingReport}}</text><br/>
    <text>消息数量: {{chatMessages.length}}</text><br/>
    <text>用户消息: {{userMessageCount}}</text><br/>
    <text>角色消息: {{characterMessageCount}}</text>
  </view>
  
  <!-- 生成报告进度提示 -->
  <view class="report-progress" wx:if="{{isGeneratingReport}}">
    <text class="report-progress-text">正在生成情感报告...</text>
  </view>

  <!-- 情感复盘报告弹窗 -->
  <view wx:if="{{showEmotionReport}}" class="emotion-report-modal">
    <view class="modal-mask" bindtap="hideEmotionReport"></view>
    <view class="modal-content emotion-report-content">
      <view class="modal-header">
        <text class="modal-title">💝 情感复盘报告</text>
        <button class="modal-close" bindtap="hideEmotionReport">×</button>
      </view>
      

      <scroll-view class="report-body" scroll-y="true">
        <view class="report-section">
          <text class="section-title">📊 情感状态分析</text>
          <view class="emotion-analysis">
            <text class="analysis-text">{{emotionReport.analysis}}</text>
          </view>
        </view>
        
        <view class="report-section">
          <text class="section-title">💡 情感建议</text>
          <view class="emotion-suggestions">
            <view class="suggestion-item" wx:for="{{emotionReport.suggestions}}" wx:key="*this">
              <text class="suggestion-text">• {{item}}</text>
            </view>
          </view>
        </view>
        
        <view class="report-section">
          <text class="section-title">🎯 关注重点</text>
          <view class="focus-points">
            <view class="focus-item" wx:for="{{emotionReport.focusPoints}}" wx:key="*this">
              <text class="focus-text">🔸 {{item}}</text>
            </view>
          </view>
        </view>
        
        <view class="report-section">
          <text class="section-title">📈 情感趋势</text>
          <view class="emotion-trend">
            <text class="trend-text">{{emotionReport.trend}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 分享Canvas（隐藏） -->
  <canvas canvas-id="shareCanvas" style="position: fixed; top: -1000px; left: -1000px; width: 300px; height: 400px;"></canvas>
</view>
